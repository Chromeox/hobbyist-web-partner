name: Swift Dependency Security Scan

on:
  schedule:
    # Run every Monday at 8:00 AM UTC (7:30 AM Vancouver time)
    - cron: '0 8 * * 1'
  push:
    branches: [ main, develop ]
    paths: 
      - 'iOS/Package.swift'
      - 'iOS/Package.resolved'
  pull_request:
    branches: [ main ]
    paths:
      - 'iOS/Package.swift'
      - 'iOS/Package.resolved'
  workflow_dispatch:

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer

jobs:
  security-scan:
    name: Swift Package Security Scan
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
      
    - name: Cache Swift packages
      uses: actions/cache@v4
      with:
        path: |
          iOS/.build
          ~/Library/Caches/org.swift.swiftpm
        key: ${{ runner.os }}-swift-${{ hashFiles('iOS/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-swift-
          
    - name: Resolve Swift packages
      working-directory: iOS
      run: swift package resolve
      
    - name: Check for package updates
      id: check-updates
      working-directory: iOS
      run: |
        echo "Checking for available package updates..."
        
        # Get current versions
        SUPABASE_CURRENT=$(grep -A 1 "supabase-swift" Package.swift | grep "exact:" | sed -E 's/.*"([^"]+)".*/\1/')
        STRIPE_CURRENT=$(grep -A 1 "stripe-ios" Package.swift | grep "exact:" | sed -E 's/.*"([^"]+)".*/\1/')
        KINGFISHER_CURRENT=$(grep -A 1 "Kingfisher" Package.swift | grep "exact:" | sed -E 's/.*"([^"]+)".*/\1/')
        
        echo "Current versions:"
        echo "Supabase: $SUPABASE_CURRENT"
        echo "Stripe: $STRIPE_CURRENT"
        echo "Kingfisher: $KINGFISHER_CURRENT"
        
        # Check latest versions via GitHub API
        SUPABASE_LATEST=$(curl -s https://api.github.com/repos/supabase/supabase-swift/releases/latest | jq -r '.tag_name')
        STRIPE_LATEST=$(curl -s https://api.github.com/repos/stripe/stripe-ios/releases/latest | jq -r '.tag_name')
        KINGFISHER_LATEST=$(curl -s https://api.github.com/repos/onevcat/Kingfisher/releases/latest | jq -r '.tag_name')
        
        echo "Latest versions:"
        echo "Supabase: $SUPABASE_LATEST"
        echo "Stripe: $STRIPE_LATEST"  
        echo "Kingfisher: $KINGFISHER_LATEST"
        
        # Set outputs for later steps
        echo "supabase-current=$SUPABASE_CURRENT" >> $GITHUB_OUTPUT
        echo "supabase-latest=$SUPABASE_LATEST" >> $GITHUB_OUTPUT
        echo "stripe-current=$STRIPE_CURRENT" >> $GITHUB_OUTPUT
        echo "stripe-latest=$STRIPE_LATEST" >> $GITHUB_OUTPUT
        echo "kingfisher-current=$KINGFISHER_CURRENT" >> $GITHUB_OUTPUT
        echo "kingfisher-latest=$KINGFISHER_LATEST" >> $GITHUB_OUTPUT
        
        # Check if updates are available
        UPDATES_AVAILABLE=false
        if [ "$SUPABASE_CURRENT" != "$SUPABASE_LATEST" ]; then
          UPDATES_AVAILABLE=true
        fi
        if [ "$STRIPE_CURRENT" != "$STRIPE_LATEST" ]; then
          UPDATES_AVAILABLE=true
        fi
        if [ "$KINGFISHER_CURRENT" != "$KINGFISHER_LATEST" ]; then
          UPDATES_AVAILABLE=true
        fi
        
        echo "updates-available=$UPDATES_AVAILABLE" >> $GITHUB_OUTPUT
        
    - name: Security Advisory Check
      id: security-check
      run: |
        echo "Checking for security advisories..."
        
        # Check GitHub Security Advisories for each package
        ADVISORIES_FOUND=false
        
        # Supabase
        SUPABASE_ADVISORIES=$(curl -s "https://api.github.com/repos/supabase/supabase-swift/security-advisories" | jq length)
        if [ "$SUPABASE_ADVISORIES" -gt 0 ]; then
          echo "âš ï¸ $SUPABASE_ADVISORIES security advisories found for Supabase Swift SDK"
          ADVISORIES_FOUND=true
        fi
        
        # Stripe  
        STRIPE_ADVISORIES=$(curl -s "https://api.github.com/repos/stripe/stripe-ios/security-advisories" | jq length)
        if [ "$STRIPE_ADVISORIES" -gt 0 ]; then
          echo "âš ï¸ $STRIPE_ADVISORIES security advisories found for Stripe iOS SDK"
          ADVISORIES_FOUND=true
        fi
        
        # Kingfisher
        KINGFISHER_ADVISORIES=$(curl -s "https://api.github.com/repos/onevcat/Kingfisher/security-advisories" | jq length)
        if [ "$KINGFISHER_ADVISORIES" -gt 0 ]; then
          echo "âš ï¸ $KINGFISHER_ADVISORIES security advisories found for Kingfisher"
          ADVISORIES_FOUND=true
        fi
        
        echo "advisories-found=$ADVISORIES_FOUND" >> $GITHUB_OUTPUT
        
    - name: Build validation
      working-directory: iOS
      run: |
        echo "Performing build validation..."
        swift build --configuration release
        
    - name: Package resolution test
      working-directory: iOS
      run: |
        echo "Testing package resolution speed..."
        time swift package resolve
        
    - name: Generate Security Report
      if: always()
      run: |
        cat > security-report.md << EOF
        # Swift Package Security Report
        Generated: $(date)
        
        ## Current Package Versions
        - Supabase Swift SDK: ${{ steps.check-updates.outputs.supabase-current }}
        - Stripe iOS SDK: ${{ steps.check-updates.outputs.stripe-current }}
        - Kingfisher: ${{ steps.check-updates.outputs.kingfisher-current }}
        
        ## Latest Available Versions
        - Supabase Swift SDK: ${{ steps.check-updates.outputs.supabase-latest }}
        - Stripe iOS SDK: ${{ steps.check-updates.outputs.stripe-latest }}
        - Kingfisher: ${{ steps.check-updates.outputs.kingfisher-latest }}
        
        ## Security Status
        - Security advisories detected: ${{ steps.security-check.outputs.advisories-found }}
        - Updates available: ${{ steps.check-updates.outputs.updates-available }}
        - Build validation: ${{ job.status }}
        
        ## Recommendations
        $(if [ "${{ steps.check-updates.outputs.updates-available }}" = "true" ]; then
          echo "ðŸ”„ Package updates are available. Consider updating for latest security patches."
        else
          echo "âœ… All packages are up to date."
        fi)
        
        $(if [ "${{ steps.security-check.outputs.advisories-found }}" = "true" ]; then
          echo "âš ï¸ Security advisories detected. Immediate review recommended."
        else
          echo "âœ… No known security advisories."
        fi)
        EOF
        
    - name: Upload Security Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-report-${{ github.run_number }}
        path: security-report.md
        
    - name: Comment on PR with Security Report
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('security-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });
          
    - name: Fail on Critical Security Issues
      if: steps.security-check.outputs.advisories-found == 'true'
      run: |
        echo "âŒ Critical security advisories detected!"
        echo "Please review and update affected packages immediately."
        exit 1