name: App Store Deployment Automation

on:
  workflow_dispatch:
    inputs:
      deployment_type:
        description: 'Deployment Type'
        required: true
        default: 'testflight'
        type: choice
        options:
        - testflight
        - app-store
        - hotfix
      version:
        description: 'Version (for hotfix only)'
        required: false
        type: string
      changelog:
        description: 'Release Changelog'
        required: true
        type: string
      submit_for_review:
        description: 'Submit for App Store Review (app-store only)'
        required: false
        type: boolean
        default: false
      skip_tests:
        description: 'Skip Running Tests'
        required: false
        type: boolean
        default: false

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Validation
    runs-on: macos-latest
    outputs:
      can_deploy: ${{ steps.validation.outputs.can_deploy }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate Deployment Parameters
        id: validation
        run: |
          echo "üîç Validating deployment parameters..."
          
          # Validate deployment type
          case "${{ github.event.inputs.deployment_type }}" in
            testflight|app-store|hotfix)
              echo "‚úÖ Valid deployment type: ${{ github.event.inputs.deployment_type }}"
              ;;
            *)
              echo "‚ùå Invalid deployment type: ${{ github.event.inputs.deployment_type }}"
              exit 1
              ;;
          esac
          
          # Validate hotfix version if needed
          if [ "${{ github.event.inputs.deployment_type }}" = "hotfix" ]; then
            if [ -z "${{ github.event.inputs.version }}" ]; then
              echo "‚ùå Version is required for hotfix deployment"
              exit 1
            fi
            echo "‚úÖ Hotfix version: ${{ github.event.inputs.version }}"
          fi
          
          # Validate changelog
          if [ -z "${{ github.event.inputs.changelog }}" ]; then
            echo "‚ùå Changelog is required"
            exit 1
          fi
          
          echo "‚úÖ All deployment parameters are valid"
          echo "can_deploy=true" >> $GITHUB_OUTPUT
      
      - name: Check Branch Protection
        run: |
          if [ "$GITHUB_REF" != "refs/heads/main" ]; then
            echo "‚ö†Ô∏è Deployment from non-main branch detected"
            echo "Current branch: $GITHUB_REF"
            echo "Proceeding with caution..."
          else
            echo "‚úÖ Deploying from main branch"
          fi
      
      - name: Validate Required Secrets
        run: |
          echo "üîê Checking required secrets..."
          
          required_secrets=(
            "MATCH_PASSWORD"
            "FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD" 
            "APPLE_ID"
            "DEVELOPER_TEAM_ID"
            "APP_STORE_CONNECT_TEAM_ID"
            "MATCH_GIT_URL"
          )
          
          missing_secrets=()
          
          for secret in "${required_secrets[@]}"; do
            if [ -z "${!secret}" ]; then
              missing_secrets+=("$secret")
            fi
          done
          
          if [ ${#missing_secrets[@]} -eq 0 ]; then
            echo "‚úÖ All required secrets are configured"
          else
            echo "‚ùå Missing required secrets:"
            printf '  - %s\n' "${missing_secrets[@]}"
            exit 1
          fi
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          DEVELOPER_TEAM_ID: ${{ secrets.DEVELOPER_TEAM_ID }}
          APP_STORE_CONNECT_TEAM_ID: ${{ secrets.APP_STORE_CONNECT_TEAM_ID }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}

  compliance-validation:
    name: App Store Compliance Validation
    runs-on: macos-latest
    needs: pre-deployment-checks
    if: needs.pre-deployment-checks.outputs.can_deploy == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
      
      - name: Install Dependencies
        run: |
          gem install fastlane
          brew install swiftlint
      
      - name: Compliance Checks
        run: |
          echo "üîç Running App Store compliance validation..."
          
          # Check for required App Store metadata files
          echo "üìã Checking metadata files..."
          if [ -d "fastlane/metadata" ]; then
            echo "‚úÖ Fastlane metadata directory exists"
          else
            echo "‚ö†Ô∏è Missing fastlane metadata directory"
          fi
          
          # Privacy policy validation
          echo "üîí Validating privacy requirements..."
          if grep -r "privacy.*policy" --include="*.md" --include="*.txt" .; then
            echo "‚úÖ Privacy policy references found"
          else
            echo "‚ö†Ô∏è No privacy policy references found"
          fi
          
          # Screenshot validation
          echo "üì∏ Checking screenshots..."
          if [ -d "fastlane/screenshots" ]; then
            screenshot_count=$(find fastlane/screenshots -name "*.png" | wc -l)
            echo "‚úÖ Found $screenshot_count screenshots"
          else
            echo "‚ö†Ô∏è No screenshots directory found"
          fi
          
          # SwiftLint compliance check
          echo "üìù Running SwiftLint compliance check..."
          if swiftlint --reporter json > swiftlint_results.json; then
            echo "‚úÖ SwiftLint compliance check passed"
          else
            echo "‚ö†Ô∏è SwiftLint found issues (non-blocking)"
          fi
      
      - name: Upload Compliance Report
        uses: actions/upload-artifact@v4
        with:
          name: compliance-report
          path: |
            swiftlint_results.json

  automated-deployment:
    name: Automated App Store Deployment
    runs-on: macos-latest
    needs: [pre-deployment-checks, compliance-validation]
    if: needs.pre-deployment-checks.outputs.can_deploy == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
      
      - name: Setup Fastlane Environment
        run: |
          gem install fastlane
          fastlane --version
      
      - name: Configure Deployment Environment
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          DEVELOPER_TEAM_ID: ${{ secrets.DEVELOPER_TEAM_ID }}
          APP_STORE_CONNECT_TEAM_ID: ${{ secrets.APP_STORE_CONNECT_TEAM_ID }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          BETA_FEEDBACK_EMAIL: ${{ secrets.BETA_FEEDBACK_EMAIL }}
        run: |
          echo "üîß Setting up deployment environment..."
          
          # Create .env file for Fastlane
          cat > /Users/chromefang.exe/HobbyistSwiftUI/fastlane/.env << EOF
          APPLE_ID=$APPLE_ID
          DEVELOPER_TEAM_ID=$DEVELOPER_TEAM_ID
          APP_STORE_CONNECT_TEAM_ID=$APP_STORE_CONNECT_TEAM_ID
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD=$FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD
          MATCH_PASSWORD=$MATCH_PASSWORD
          MATCH_GIT_URL=$MATCH_GIT_URL
          MATCH_GIT_BASIC_AUTHORIZATION=$MATCH_GIT_BASIC_AUTHORIZATION
          SLACK_WEBHOOK_URL=$SLACK_WEBHOOK_URL
          BETA_FEEDBACK_EMAIL=$BETA_FEEDBACK_EMAIL
          CI=true
          EOF
          
          echo "‚úÖ Deployment environment configured"
      
      - name: Run Tests (if not skipped)
        if: github.event.inputs.skip_tests != 'true'
        run: |
          echo "üß™ Running comprehensive test suite..."
          cd /Users/chromefang.exe/HobbyistSwiftUI
          fastlane test
      
      - name: Deploy to TestFlight
        if: github.event.inputs.deployment_type == 'testflight'
        run: |
          echo "üöÄ Deploying to TestFlight..."
          cd /Users/chromefang.exe/HobbyistSwiftUI
          fastlane release_testflight changelog:"${{ github.event.inputs.changelog }}"
      
      - name: Deploy to App Store
        if: github.event.inputs.deployment_type == 'app-store'
        run: |
          echo "üè™ Deploying to App Store..."
          cd /Users/chromefang.exe/HobbyistSwiftUI
          fastlane release_app_store \
            submit_for_review:${{ github.event.inputs.submit_for_review }} \
            automatic_release:false \
            phased_release:true
      
      - name: Create Hotfix Release
        if: github.event.inputs.deployment_type == 'hotfix'
        run: |
          echo "üöë Creating hotfix release..."
          cd /Users/chromefang.exe/HobbyistSwiftUI
          fastlane hotfix_release \
            version:"${{ github.event.inputs.version }}" \
            changelog:"${{ github.event.inputs.changelog }}"
      
      - name: Generate Deployment Report
        if: always()
        run: |
          echo "üìä Generating deployment report..."
          
          # Get build information
          BUILD_NUMBER=$(cat /Users/chromefang.exe/HobbyistSwiftUI/build/build_number.txt 2>/dev/null || echo "Unknown")
          BUILD_VERSION=$(cat /Users/chromefang.exe/HobbyistSwiftUI/build/version_number.txt 2>/dev/null || echo "Unknown")
          
          cat > deployment_report.md << EOF
          # Deployment Report
          
          ## üöÄ Deployment Summary
          - **Type**: ${{ github.event.inputs.deployment_type }}
          - **Version**: ${BUILD_VERSION}
          - **Build**: ${BUILD_NUMBER}
          - **Date**: $(date)
          - **Initiated By**: ${{ github.actor }}
          - **Branch**: ${{ github.ref_name }}
          - **Commit**: ${{ github.sha }}
          
          ## üìù Changelog
          ${{ github.event.inputs.changelog }}
          
          ## ‚öôÔ∏è Configuration
          - **Skip Tests**: ${{ github.event.inputs.skip_tests }}
          - **Submit for Review**: ${{ github.event.inputs.submit_for_review }}
          
          ## üìä Build Metrics
          - **Build Duration**: \$(date -d @\$((SECONDS)) -u +%H:%M:%S)
          - **Platform**: macOS (GitHub Actions)
          - **Xcode Version**: \$(xcodebuild -version | head -1)
          
          ## üéØ Next Steps
          EOF
          
          case "${{ github.event.inputs.deployment_type }}" in
            testflight)
              cat >> deployment_report.md << EOF
          - Check TestFlight for processing status
          - Monitor crash reports and user feedback
          - Prepare for broader rollout based on alpha feedback
          EOF
              ;;
            app-store)
              if [ "${{ github.event.inputs.submit_for_review }}" = "true" ]; then
                cat >> deployment_report.md << EOF
          - Monitor App Store Connect for review status
          - Respond to any review feedback promptly
          - Prepare for phased release upon approval
          EOF
              else
                cat >> deployment_report.md << EOF
          - Review build in App Store Connect
          - Submit for review when ready
          - Update metadata and screenshots if needed
          EOF
              fi
              ;;
            hotfix)
              cat >> deployment_report.md << EOF
          - Monitor hotfix deployment in TestFlight
          - Verify critical fixes are working as expected
          - Consider expedited App Store review if critical
          EOF
              ;;
          esac
          
          echo "Generated deployment report:"
          cat deployment_report.md
      
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: deployment-artifacts
          path: |
            /Users/chromefang.exe/HobbyistSwiftUI/build/
            /Users/chromefang.exe/HobbyistSwiftUI/test_output/
            deployment_report.md
      
      - name: Send Success Notification
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
                 --data "{\"text\":\"‚úÖ **Deployment Successful!**\n\nüöÄ **Type**: ${{ github.event.inputs.deployment_type }}\nüì± **App**: HobbyistSwiftUI\nüë§ **By**: ${{ github.actor }}\nüìù **Changelog**: ${{ github.event.inputs.changelog }}\n\n$(date)\"}" \
                 "$SLACK_WEBHOOK_URL"
          fi
      
      - name: Send Failure Notification
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
                 --data "{\"text\":\"‚ùå **Deployment Failed!**\n\nüöÄ **Type**: ${{ github.event.inputs.deployment_type }}\nüì± **App**: HobbyistSwiftUI\nüë§ **By**: ${{ github.actor }}\nüìù **Check**: [GitHub Actions Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n$(date)\"}" \
                 "$SLACK_WEBHOOK_URL"
          fi

  post-deployment-monitoring:
    name: Post-Deployment Monitoring Setup
    runs-on: macos-latest
    needs: automated-deployment
    if: success()
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Monitoring Alerts
        run: |
          echo "üìä Setting up post-deployment monitoring..."
          
          # Create monitoring configuration
          cat > monitoring_config.json << EOF
          {
            "deployment_type": "${{ github.event.inputs.deployment_type }}",
            "version": "$(cat /Users/chromefang.exe/HobbyistSwiftUI/build/version_number.txt 2>/dev/null || echo 'Unknown')",
            "build": "$(cat /Users/chromefang.exe/HobbyistSwiftUI/build/build_number.txt 2>/dev/null || echo 'Unknown')",
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "monitoring": {
              "crash_rate_threshold": 0.05,
              "user_rating_threshold": 3.5,
              "performance_degradation_threshold": 0.2
            }
          }
          EOF
          
          echo "‚úÖ Monitoring configuration created"
          cat monitoring_config.json
      
      - name: Schedule Follow-up Checks
        run: |
          echo "‚è∞ Scheduling post-deployment follow-up checks..."
          
          case "${{ github.event.inputs.deployment_type }}" in
            testflight)
              echo "üì± TestFlight monitoring scheduled:"
              echo "  - 1 hour: Build processing status check"
              echo "  - 24 hours: Initial crash rate analysis" 
              echo "  - 7 days: Weekly alpha feedback summary"
              ;;
            app-store)
              if [ "${{ github.event.inputs.submit_for_review }}" = "true" ]; then
                echo "üè™ App Store review monitoring scheduled:"
                echo "  - 24 hours: Review status check"
                echo "  - 7 days: Review status reminder"
              else
                echo "üè™ App Store build monitoring scheduled:"
                echo "  - 4 hours: Build processing confirmation"
                echo "  - Manual review submission reminder set"
              fi
              ;;
            hotfix)
              echo "üöë Hotfix monitoring scheduled:"
              echo "  - 30 minutes: TestFlight processing check"
              echo "  - 2 hours: Critical metrics validation"
              echo "  - 24 hours: Hotfix effectiveness report"
              ;;
          esac
      
      - name: Upload Monitoring Configuration
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-configuration
          path: monitoring_config.json